{% extends 'base.html' %}
{% load myfilters %}
{% load socialaccount %}
{% load static %}
{% block styles %}
<link rel="stylesheet" type="text/css" href="{% static 'css/searchreasult.css' %}">
<script src="https://js.stripe.com/v3/"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>
<style>
   

form {
  width: 100%;
  min-width: 100%;
  align-self: center;
  box-shadow: 0px 0px 0px 0.5px rgba(50, 50, 93, 0.1),
    0px 2px 5px 0px rgba(50, 50, 93, 0.1), 0px 1px 1.5px 0px rgba(0, 0, 0, 0.07);
  border-radius: 7px;
  padding: 40px;
}
input {
  border-radius: 6px;
  margin-bottom: 6px;
  padding: 12px;
  border: 1px solid rgba(50, 50, 93, 0.1);
  height: 44px;
  font-size: 16px;
  width: 100%;
  background: white;
}
.result-message {
  line-height: 22px;
  font-size: 16px;
}
.result-message a {
  color: rgb(89, 111, 214);
  font-weight: 600;
  text-decoration: none;
}
.hidden {
  display: none;
}
#card-error {
  color: rgb(105, 115, 134);
  text-align: left;
  font-size: 13px;
  line-height: 17px;
  margin-top: 12px;
}
#card-element {
  border-radius: 4px 4px 0 0 ;
  padding: 12px;
  border: 1px solid rgba(50, 50, 93, 0.1);
  height: 44px;
  width: 100%;
  background: white;
}
#payment-request-button {
  margin-bottom: 32px;
}
/* Buttons and links */
button {
  background: #5469d4;
  color: #ffffff;
  border-radius: 0 0 4px 4px;
  border: 0;
  padding: 12px 16px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: block;
  transition: all 0.2s ease;
  box-shadow: 0px 4px 5.5px 0px rgba(0, 0, 0, 0.07);
  width: 100%;
}
button:hover {
  filter: contrast(115%);
}
button:disabled {
  opacity: 0.5;
  cursor: default;
}
/* spinner/processing state, errors */
.spinner,
.spinner:before,
.spinner:after {
  border-radius: 50%;
}
.spinner {
  color: #ffffff;
  font-size: 22px;
  text-indent: -99999px;
  margin: 0px auto;
  position: relative;
  width: 20px;
  height: 20px;
  box-shadow: inset 0 0 0 2px;
  -webkit-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
}
.spinner:before,
.spinner:after {
  position: absolute;
  content: "";
}
.spinner:before {
  width: 10.4px;
  height: 20.4px;
  background: #5469d4;
  border-radius: 20.4px 0 0 20.4px;
  top: -0.2px;
  left: -0.2px;
  -webkit-transform-origin: 10.4px 10.2px;
  transform-origin: 10.4px 10.2px;
  -webkit-animation: loading 2s infinite ease 1.5s;
  animation: loading 2s infinite ease 1.5s;
}
.spinner:after {
  width: 10.4px;
  height: 10.2px;
  background: #5469d4;
  border-radius: 0 10.2px 10.2px 0;
  top: -0.1px;
  left: 10.2px;
  -webkit-transform-origin: 0px 10.2px;
  transform-origin: 0px 10.2px;
  -webkit-animation: loading 2s infinite ease;
  animation: loading 2s infinite ease;
}

    </style>
{% endblock %}
{% block content %}

{% if not user.is_authenticated %}

<!--Modal: Login / Register Form-->
<div class="modal fade" id="loginPayModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document" style="max-width:50%;">
      <!--Content-->
      <div class="modal-content">
        <!--Modal cascading tabs-->
        <div class="modal-c-tabs">
  
          <!-- Nav tabs -->
          <ul class="nav nav-tabs md-tabs tabs-2 light-blue darken-3" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-toggle="tab" href="#panel7" role="tab"><i class="fas fa-user mr-1"></i>
                Login</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#panel8" role="tab"><i class="fas fa-user-plus mr-1"></i>
                Register</a>
            </li>
            <li class="nav-item">
                <a type="button" class="nav-link" href="{% url 'landing' %}">Back home</a>
              </li>

          </ul>
  
          <!-- Tab panels -->
          <div class="tab-content">
            <!--Panel 7-->
            <div class="tab-pane fade in show active" id="panel7" role="tabpanel">
  
              <!--Body-->
              <div class="modal-body mb-1">
                <form role="form" class="form-horizontal" method="post" action="{% url 'login' %}">{% csrf_token %}
                    <div class="form-group">

                        <label for="id_username" class="usernametag">USERNAME</label>
                        <input id="id_username" name="username" type="text" class="username-control-login">

                        <label for="id_password" class="passwordtag">PASSWORD</label>
                        <input id="id_password" name="password" type="text" class="password-control-login">
                        <br>
                        <input type="submit" class="signup_button"/>
                        <input type="hidden" name="next" value="/{{ urlsString }}" />
                    </div>

                </form>
                {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>username or password not correct</strong>
                </div>
                {% endif %}
              <div class="modal-footer">
                <div class="options text-center text-md-right mt-1">
                  <p>Forgot <a href="#" class="blue-text">Password?</a></p>
                </div>
              </div>
            </div>
        </div>
 
 

            <div class="tab-pane fade" id="panel8" role="tabpanel">
  

              <form id="payment-form" class="form-control">{% csrf_token %}
                <input name = "email" type="text" id="email" placeholder="Email address" class="form-control"/>
                <input name = "username" type="text" id="username" placeholder="username" class="form-control"/>
                <input name = "password" type="text" id="password" placeholder="password" class="form-control"/>

                <div id="card-element"></div>
                <button id="submit">
                  <div class="spinner hidden" id="spinner"></div>
                  <span id="button-text">Pay now</span>
                </button>
                <p id="card-error" role="alert"></p>
                <p class="result-message hidden">
                </p>
              </form>
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
var stripe = Stripe("pk_test_51IVE74GfxvWHpljQiugUY1xG2FvOnO8l6W64sVuSofMJ5SHsVVlZ5E81bLsC1BwIWptV8BL2U4ZHhesrXOyOKcRH00SdJXIHfx");
document.querySelector("button").disabled = true;
 
fetch("{% url 'create-checkout-session' %}", {
    method: "POST",
    headers: {
    'X-CSRFToken': csrftoken
    }                
    })
    .then(function(result) {
    return result.json();
    })
    .then(function(data) {
    var elements = stripe.elements();
    var style = {
        base: {
        color: "#32325d",
        fontFamily: 'Arial, sans-serif',
        fontSmoothing: "antialiased",
        fontSize: "16px",
        "::placeholder": {
            color: "#32325d"
        }
        },
        invalid: {
        fontFamily: 'Arial, sans-serif',
        color: "#fa755a",
        iconColor: "#fa755a"
        }
    };
    var card = elements.create("card", { style: style });
    // Stripe injects an iframe into the DOM
    card.mount("#card-element");
    card.on("change", function (event) {
        // Disable the Pay button if there are no card details in the Element
        document.querySelector("button").disabled = event.empty;
        document.querySelector("#card-error").textContent = event.error ? event.error.message : "";
    });
    var form = document.getElementById("payment-form");
    var formData = JSON.stringify($("payment-form").serializeArray());

    form.addEventListener("submit", function(event) {
        event.preventDefault();
        // Complete payment when the submit button is clicked
        payWithCard(stripe, card, data.client_secret);


        // Send for data back to the server
        var formElement = document.querySelector("#payment-form");
        var request = new XMLHttpRequest();
        request.open("POST", "{% url 'checkout' %}");
        console.log(formElement)
        request.send(new FormData(formElement));
        // Show a sucess message
        closeAllModals()

    });

});
                

// Calls stripe.confirmCardPayment
// If the card requires authentication Stripe shows a pop-up modal to
// prompt the user to enter authentication details without leaving your page.
var payWithCard = function(stripe, card, clientSecret) {
    loading(true);
  stripe
  .confirmCardPayment(clientSecret, {
      payment_method: {
        card: card
      }
    })

    // console.log(result)
    // .then(function(result) {
    //     if (result.error) {
    //     // Show error to your customer
    //     showError(result.error.message);
    //     } else {
    //     // The payment succeeded!
    //     console.log("order made")
    //     orderComplete(result.paymentIntent.id);
    //     //  If payment and login was sucessfull remove the modal

    //     }
    // });
};
/* ------- UI helpers ------- */
// Shows a success message when the payment is complete
var orderComplete = function(paymentIntentId) {
    loading(false);
    document
    .querySelector(".result-message a")
    .setAttribute(
        "href",
        "https://dashboard.stripe.com/test/payments/" + paymentIntentId
    );
    document.querySelector(".result-message").classList.remove("hidden");
    document.querySelector("button").disabled = true;
};
// Show the customer the error from Stripe if their card fails to charge
var showError = function(errorMsgText) {
    loading(false);
    var errorMsg = document.querySelector("#card-error");
    errorMsg.textContent = errorMsgText;
    setTimeout(function() {
    errorMsg.textContent = "";
    }, 4000);
};
// Show a spinner on payment submission
var loading = function(isLoading) {
    if (isLoading) {
    // Disable the button and show a spinner
    document.querySelector("button").disabled = true;
    document.querySelector("#spinner").classList.remove("hidden");
    document.querySelector("#button-text").classList.add("hidden");
    } else {
    document.querySelector("button").disabled = false;
    document.querySelector("#spinner").classList.add("hidden");
    document.querySelector("#button-text").classList.remove("hidden");
    }
};

function closeAllModals() {
    // get modals
    const modals = document.getElementsByClassName('modal');

    // on every modal change state like in hidden modal
    for(let i=0; i<modals.length; i++) {
    modals[i].classList.remove('show');
    modals[i].setAttribute('aria-hidden', 'true');
    modals[i].setAttribute('style', 'display: none');
    }

    // get modal backdrops
    const modalsBackdrops = document.getElementsByClassName('modal-backdrop');

    // remove every modal backdrop
    for(let i=0; i<modalsBackdrops.length; i++) {
    document.body.removeChild(modalsBackdrops[i]);
 }
}
            
              </script>

                </div>
  
              </div>
              <div class="modal-footer">
                <div class="options text-right">
                </div>
              </div>
        </div>
</div>
</div>
</div>


{% endif %}

<div class="row">
<div class="col-4">
<h1>Review Timeline</h1>
<img id="u251_img" class="u251_img" src={% static "images/onereasult/u250.png" %} />
<h4>Click on a review year to see what past tennants thought</h4>
<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    {% for review in reviews %}
    <!-- make newest tab show first..so make sure it comes through in correct order from db -->
    <li class="nav-item">
        <!-- find way to make newest tab active at start.. -->
        <a class="nav-link" id={{review}} data-toggle="pill" href=#{{review.id}} role="tab"
            aria-controls={{review.id}} aria-selected="true">{{review.moveIn}} - {{review.moveOut}}</a>
    </li>
    {% endfor %}
</ul>

<iframe
    width="400"
    height="450"
    style="border:0"
    loading="lazy"
    allowfullscreen
    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyDlVTN-szxnm6ZMM8yWxZuuBIREfD8snjk
        &q={{property.address}}">
</iframe>
</div>
<div class="col-8">
<div class ="aggregateValueDiv"><h4>Review timeline for {{property.address}}</h4>
        <h6>
    Average overall rating over all reviews of this property:
    <div class="keyBox">
    {% for i in aggregateReview|times %}
                <img src="{% static "images/search_results/u53.png" %}" class="Rating--Star">

                {% endfor %}

                {% for i in aggregateReview|leftover %}
                    <img src="{% static "images/search_results/u52.png" %}" class="Rating--Star">
                {% endfor %}
    </div>
    </h6>
</div>
</div>  
        <hr>

<div class="tab-content" id="pills-tabContent">
    {% for review in reviews %}


    {% endfor %}

</div>
</div>  


<script>
    jQuery(function(){
       jQuery('.nav-link').click();
    });
</script>
<script>
    $(document).ready(function(){
        $("#loginPayModal").modal('show');
    });
    </script>
<script src="https://polyfill.io/v3/polyfill.min.js?version=3.52.1&features=fetch"></script>


{% endblock %}


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
    crossorigin="anonymous"></script>
< src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></>
< src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></>